{% extends "views/components/widgets/base.htm" %}
{% load i18n %}

{% block form %}
<div class="row widget-wrapper file-preview">
    <div 
        class="form-group"
        style="display: flex; flex-direction: column;"
    >
        <label class="control-label widget-input-label" for="" data-bind="text:label"></label>

        <!-- ko if: node -->
        <i data-bind="css: {'ion-asterisk widget-label-required': node.isrequired}"></i>
        <!-- /ko -->
        
        <div class="col-xs-12 dropzone" data-bind="dropzone: dropzoneOptions">
            <div 
                style="
                    border: 1px dashed #bbb;
                    border-radius: 6px;
                "
                data-bind="
                    visible: addedFiles().length === 0
                "
            >
            <div 
                class="fileinput-button dz-clickable" 
                style="
                    cursor: pointer;
                "
                data-bind="css: uniqueidClass"
            >
                <div 
                    class="pad-ver file-select"
                    style="padding: 5px 10px"
                >
                    <div style="padding: 5px;">
                        <h3>
                            {% trans "Drag files here to add" %}
                        </h3>

                        <div style="font-weight: lighter;">
                            {% trans "( or click to manually select a file )" %}
                        </div>

                        <div 
                            style="
                                margin-top: 18px;
                                border-top: 1px solid #ddd;
                            "
                        >
                            <div
                                style="
                                    font-weight: lighter;
                                    font-size: 12px;
                                    display: flex;
                                    justify-content: space-between;
                                    margin-top: 8px;
                                    padding: 0 4px;
                                "
                            >

                                <div>
                                    <span>{% trans "Allowed formats:" %}</span>
                                    <span data-bind="text: (acceptedFiles() || 'Any')"></span>
                                </div>
                                
                                <div>
                                    <span>{% trans "Maximum size:" %}</span>
                                    <span data-bind="text: maxFilesize() + 'MB'"></span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
            
            </div>

            <!-- 
                note that data-bind=visible must be in place (instead of ko if:) as DZ instantiates only once;
                elements it depends on must exist at time of init 
            -->
            <div 
                style="border: unset;"
                class="dz-previews" 
                data-bind="{
                    visible: addedFiles().length > 0,
                    css: uniqueidClass,
                }"
            >
                <div
                    style="
                        display: flex;
                        justify-content: space-between;
                    "
                >
                    <h4>{% trans "Uploaded Files" %}</h4>

                    <div 
                        class="file-upload-options"
                        style="padding: 10px 0px;"
                    >
                        <!-- ko if: filter() -->
                        <span data-bind="text: filteredList().length+' out of '+addedFiles().length+' files match filter'"></span>
                        <!-- /ko -->

                        <!-- ko if: (!filter() || filter() == "") -->
                        <span data-bind="text: addedFiles().length + '{% trans " file(s) uploaded" %}'"></span>
                        <!-- /ko -->
                    </div>
                </div>

                <!--ko if: addedFiles().length > 1-->
                <input 
                    data-bind="textInput: filter" 
                    type="text" placeholder="{% trans 'find a file...' %}" 
                    class="file-upload-filter"
                    style="
                        width:100%;
                        margin-bottom: 6px;
                    "
                >
                <!-- /ko -->

                <!-- Clear Search -->
                <div 
                    style="
                        position: absolute;
                        top: 44px;
                        left: 320px;
                        cursor: pointer;
                    " 
                    data-bind="visible: filter().length > 0, click: function() { filter(''); }"
                >
                    <i class="fa fa-times-circle"></i>
                </div>

                <div 
                    style="
                        display: flex;
                        justify-content: space-between;
                        padding-bottom: 8px;
                    "
                >

                    <div>

                        <button 
                            type="button" 
                            class="btn btn-file-upload-reset dropzone fileinput-button dz-clickable" 
                            style="padding: unset;"
                            data-bind="css: uniqueidClass"
                        >
                            <span>{% trans "Add another file" %}</span>
                        </button>
                    </div>

                    <button 
                        type="button" 
                        class="btn btn-file-upload-reset"
                        style="
                            padding: unset;
                        " 
                        data-bind="click: reset"
                    >
                        <span>{% trans "Remove all files" %}</span>
                    </button>
                </div>

                <div 

                    data-bind=""
                ></div>

                <!-- ko if: addedFiles().length > 0 -->
                    <table
                        style="
                            display: flex;
                            overflow: hidden;
                            border: 1px solid #D3E5F4;
                            border-bottom: unset;
                            max-height: 150px;
                        "
                    >
                        <tbody
                            style="overflow: scroll;"
                            data-bind="foreach: filter() ? filteredList : addedFiles"
                        >
                            <tr class="file-upload-card">
                                <td>
                                    <div class="media-body">
                                        <div style="display: flex;">
                                            <div
                                                style="
                                                    display: flex;
                                                    align-items: center;
                                                    margin-left: 8px;
                                                "
                                            >
                                                <button 
                                                    class="btn btn-xs btn-danger btn-file-cancel"
                                                    data-bind="click: $parent.removeFile"
                                                >
                                                    <i class="ion ion-close"></i>
                                                </button>
                                            </div>
    
                                            <div class="file-upload-card-detail">
                                                <div
                                                    style="padding: 0 8px;"
                                                >
                                                    <span 
                                                        style="white-space: nowrap;"
                                                        data-bind="text: name"
                                                    ></span>
    
                                                    <!-- ko if: $data.error -->
                                                    <span class="dz-error text-danger text-sm" data-bind="text: '{% trans "error" %}'"></span>
                                                    <!-- /ko -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                <!-- /ko -->
            </div>
        </div>


        <!-- ko if: ko.unwrap(uncreatedResourceData).length > 0-->
        <div
            style="padding-top: 12px;"
        >
            <div
                class="control-label widget-input-label"
                style="padding-bottom: 5px;"
            >
                {% trans "Resource Preview" %}
            </div>
    
            <div
                style="
                    width: 100%;
                    overflow-x: scroll;
                    padding-bottom: 14px;
                "
            >
                <table
                    style="
                        display: flex;
                        border-top: 1px solid #ddd;
                    "
                >
                    <tbody
                        style="overflow: hidden;"
                    >
                        <!-- ko foreach: uncreatedResourceData() -->
                                <tr
                                    style="
                                        display: flex;
                                        border: 1px solid #ddd;
                                        border-top: unset;
                                        white-space: nowrap;
                                        cursor: pointer
                                    "
                                    data-bind="
                                        style: { 
                                            backgroundColor: (function(){
                                                if (
                                                    $parent.selectedResourceData() === $data.row_id
                                                    && !_.isEmpty(ko.unwrap($data['errors']))
                                                ) {
                                                    return 'purple'
                                                }
                                                else if ($parent.selectedResourceData() === $data.row_id) {
                                                    return 'blue'
                                                }
                                                else if (!_.isEmpty(ko.unwrap($data['errors']))) {
                                                    return 'red'
                                                }
                                            })(),
                                            color: ( $parent.selectedResourceData() === $data.row_id || !_.isEmpty(ko.unwrap($data['errors'])) )  && 'white',  
                                        },
                                        click: function() { $parents[1].bar($data); $parent.selectedResourceData($data.row_id) },
                                    "
                                >
                                    <td 
                                        style="
                                            display: flex;
                                            align-items: center;
                                            padding-left: 8px;
                                        "
                                        data-bind="
                                            visible: !_.isEmpty(ko.unwrap($data['errors']))
                                        "
                                    >
                                        <i class="fa fa-exclamation-circle"></i>
                                    </td>
                                    <!-- ko foreach: { data: Object.keys(CSV_COLUMN_NAMES_TO_NODE_IDS), as: 'key' } -->
                                        <!-- ko if: CSV_COLUMN_NAMES_TO_NODE_IDS[key]['visible'] -->
                                            <td 
                                                style="
                                                    display: flex;
                                                    align-items: center;
                                                    border-right: 1px solid #ddd;
                                                    overflow: scroll;
                                                    flex: 1;
                                                "
                                            >
                                                <span
                                                    style="padding: 0 8px"
                                                    data-bind="{
                                                        text:(function(){
                                                            var nodeId = CSV_COLUMN_NAMES_TO_NODE_IDS[key]['node_id'];
                                                            return $parent['row_data'][nodeId];
                                                        })()
                                                    }"
                                                ></span>
                                            </td>
                                        <!-- /ko -->
                                    <!-- /ko -->
                                    <td
                                        style="display: flex;"
                                    >
                                        <button 
                                            class="btn btn-link"
                                            data-bind="click: function() { $parent.deleteResourceDatum($data.row_id) }"
                                        >
                                            <i style="margin-right: 3px;" class="fa fa-trash"></i>
                                            <span>{% trans "Delete" %}</span>
                                        </button>
                                    </td>
                                </tr>

                        <!-- /ko -->
                    </tbody>
                </table>
            </div>

            <button 
                class="btn btn-success"
                data-bind="{
                    click: createResources,
                    enable: !resourceDataHasErrors(),
                }"
            >
                {% trans 'Create Resources' %}
            </button>
        </div>
        <!-- /ko -->
    </div>

</div>

<template id="file-widget-dz-preview"><span></span></template>
{% endblock form %}

{% block config_form %}
<div class="control-label">
    {% trans "Accepted File Types" %}
</div>
<div class="col-xs-12 pad-no crud-widget-container">
    <input type="" placeholder="{% trans "example: .jpg, .png, .txt" %}" id="" class="form-control input-md widget-input" data-bind="value: acceptedFiles, valueUpdate: 'keyup'">
</div>

<div class="control-label">
    {% trans "Max File Size (mb)" %}
</div>
<div class="col-xs-12 pad-no crud-widget-container">
    <input type="number" placeholder="{% trans "Max File Size (mb)" %}" id="" class="form-control input-md widget-input" data-bind="value: maxFilesize">
</div>

{% endblock config_form %}
